# n8n Docker Compose 配置文件 - 使用 PostgreSQL 作为数据库
version: '3.8'

services:
  # n8n 工作流自动化服务
  n8n:
    image: n8nio/n8n:2.0.2  # 指定 n8n 版本
    restart: always  # 自动重启策略
    ports:
      - "5678:5678"  # 将主机的 5678 端口映射到容器的 5678 端口
    environment:
      # Node.js 环境
      - NODE_ENV=production  # 生产环境模式
      - N8N_HOST=localhost    # n8n 访问地址
      - N8N_PORT=5678        # n8n 监听端口
      - N8N_PROTOCOL=http     # 使用 HTTP 协议
      - GENERIC_TIMEZONE=Asia/Shanghai
      - TZ= Asia/Shanghai
      # 加密密钥 - 请修改为安全的随机密钥
      # - N8N_ENCRYPTION_KEY=your-secret-encryption-key-here

      # PostgreSQL 数据库配置
      - N8N_DATABASE_TYPE=postgres        # 数据库类型
      - N8N_DATABASE_POSTGRES_HOST=postgres  # 数据库主机名
      - N8N_DATABASE_POSTGRES_PORT=5432      # 数据库端口
      - N8N_DATABASE_POSTGRES_DATABASE=n8n  # 数据库名称
      - N8N_DATABASE_POSTGRES_USER=n8n      # 数据库用户名
      - N8N_DATABASE_POSTGRES_PASSWORD=n8n_password  # 数据库密码

      # 基础认证配置
      - N8N_BASIC_AUTH_ACTIVE=true      # 启用基础认证
      - N8N_BASIC_AUTH_USER=admin       # 管理员用户名
      - N8N_BASIC_AUTH_PASSWORD=admin_password  # 管理员密码

    volumes:
      - n8n_data:/home/node/.n8n  # 挂载卷，持久化 n8n 数据
    depends_on:
      - postgres  # 依赖 postgres 服务
    networks:
      - n8n-network  # 使用自定义网络

  # PostgreSQL 数据库服务
  postgres:
    image: postgres:15 # 使用 Alpine Linux 版本的 PostgreSQL 15
    restart: always  # 自动重启策略
    environment:
      - POSTGRES_DB=n8n        # 默认数据库名称
      - POSTGRES_USER=n8n      # 数据库超级用户
      - POSTGRES_PASSWORD=n8n_password  # 数据库用户密码
    volumes:
      - postgres_data:/var/lib/postgresql/data  # 持久化 PostgreSQL 数
    ports:
      - "5432:5432"  # 将主机的 5432 端口映射到容器的 5432 端口
    networks:
      - n8n-network  # 使用自定义网络
  task-runners:
    image: n8nio/runners:2.0.2
    container_name: n8n-runners
    environment:
      - N8N_RUNNERS_TASK_BROKER_URI=http://n8n-main:5679
      # - N8N_RUNNERS_AUTH_TOKEN=your-secret-here
      # etc.
    depends_on:
      - n8n
    networks:
      - n8n-network  # 使用自定义网络
# 定义持久化存储卷
volumes:
  n8n_data:      # n8n 工作流和数据存储
  postgres_data: # PostgreSQL 数据库文件存储

# 定义自定义网络
networks:
  n8n-network:
    driver: bridge  # 使用网桥驱动