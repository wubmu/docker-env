<?xml version="1.0"?>
<yandex>
    <!-- 日志级别 -->
    <logger>
        <level>information</level>
        <console>true</console>
    </logger>

    <!-- HTTP协议设置 -->
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <mysql_port>9004</mysql_port>
    <postgresql_port>9005</postgresql_port>

    <!-- 监听所有接口 -->
    <listen_host>::</listen_host>

    <!-- 数据库目录 -->
    <path>/var/lib/clickhouse/</path>
    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>
    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>
    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>

    <!-- 时区设置 -->
    <timezone>Asia/Shanghai</timezone>

    <!-- 服务级别设置（适用于所有用户） -->
    <max_concurrent_queries>20</max_concurrent_queries>
    <max_server_connections>4096</max_server_connections>

    <!-- 数据库默认引擎 -->
    <default_database_engine>Ordinary</default_database_engine>

    <!-- 数据压缩设置 -->
    <compression>
        <case>
            <min_part_size>1000000000</min_part_size>
            <min_part_size_ratio>0.01</min_part_size_ratio>
            <method>lz4</method>
        </case>
    </compression>

    <!-- 允许使用DDL -->
    <allow_ddl>1</allow_ddl>

    <!-- 开启内置字典 -->
    <builtin_dictionaries_reload_interval>3600</builtin_dictionaries_reload_interval>

    <!-- 用户目录配置 -->
    <user_directories>
        <users_xml>
            <path>/etc/clickhouse-server/users.xml</path>
        </users_xml>
    </user_directories>

    <!-- 缓存设置（低内存环境优化） -->
    <mark_cache_size>536870912</mark_cache_size>  <!-- 512MB -->
    <uncompressed_cache_size>268435456</uncompressed_cache_size>  <!-- 256MB -->

    <!-- 服务级最大线程数（CPU核心数） -->
    <max_threads>2</max_threads>

    <!-- MergeTree服务级设置 -->
    <merge_tree>
        <max_suspicious_broken_parts>2</max_suspicious_broken_parts>
        <parts_to_delay_insert>50</parts_to_delay_insert>
        <parts_to_throw_insert>100</parts_to_throw_insert>
        <max_bytes_to_merge_at_max_space_in_pool>1073741824</max_bytes_to_merge_at_max_space_in_pool>
        <min_bytes_for_wide_part>0</min_bytes_for_wide_part>
        <min_rows_for_wide_part>0</min_rows_for_wide_part>
    </merge_tree>

    <!-- 禁用一些高级功能以节省内存 -->
    <enable_protobuf_compression>0</enable_protobuf_compression>
    <enable_compressed_flag>0</enable_compressed_flag>
</yandex>